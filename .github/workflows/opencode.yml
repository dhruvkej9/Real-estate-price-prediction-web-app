name: opencode

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  opencode:
    if: |
      github.actor != 'opencode-agent[bot]' &&
      (
        contains(github.event.comment.body, ' /oc') ||
        startsWith(github.event.comment.body, '/oc') ||
        contains(github.event.comment.body, ' /opencode') ||
        startsWith(github.event.comment.body, '/opencode')
      )
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Write OpenCode auth.json
        shell: bash
        run: |
          mkdir -p ~/.local/share/opencode
          echo "${{ secrets.OPENCODE_AUTH_JSON_B64 }}" | base64 -d > ~/.local/share/opencode/auth.json
          chmod 600 ~/.local/share/opencode/auth.json

      - name: Configure OpenCode variant
        shell: bash
        run: |
          mkdir -p ~/.config/opencode
          cat > ~/.config/opencode/opencode.json <<'JSON'
          {
            "$schema": "https://opencode.ai/config.json",
            "agent": {
              "build": {
                "model": "openai/gpt-5.3-codex",
                "variant": "high",
                "prompt": "Use ripgrep (rg) instead of grep/glob/find for searching. Commands: rg 'pattern' (search content), rg --files (list all files), rg --files -g '*.ext' (filter by extension), rg --files -g '*.{js,py,md}' (multiple extensions), rg 'pattern' -g '*.ext' (search in specific file types), rg -i 'pattern' (case insensitive), rg -C 3 'pattern' (show 3 lines context). ripgrep is faster and respects .gitignore by default. Use context7 for latest package info.\n\nUse websearch when local context is insufficient. At least one websearch is recommended for each task before finalizing.\n\nUse supermemory MCP for long-term memory:\n- At task start, fetch relevant context about user preferences, coding style, and project conventions.\n- During the task, save important decisions, constraints, and TODO follow-ups.\n- Before final response, store a concise summary of what changed and why.\n\nUse MCP tools intentionally:\n- Use chrome-devtools MCP for browser debugging, performance bottlenecks, network waterfall, runtime errors, DOM/CSS inspection, and rendering issues.\n- For frontend or integration fixes, validate behavior and include what you verified in your response.\n"
              }
            },
            "watcher": {
              "ignore": [
                "node_modules/**",
                "dist/**",
                ".git/**"
              ]
            },
            "mcp": {
              "supermemory": {
                "type": "remote",
                "url": "https://mcp.supermemory.ai/mcp",
                "headers": {
                  "Authorization": "Bearer ${{ secrets.SUPERMEMORY_API_KEY }}"
                },
                "enabled": true
              },
              "chrome-devtools": {
                "type": "local",
                "command": [
                  "npx",
                  "-y",
                  "chrome-devtools-mcp@latest"
                ],
                "enabled": true
              }
            },
            "lsp": false,
            "permission": {
              "external_directory": "allow",
              "question": "allow",
              "*": "allow"
            }
          }
          JSON

      - name: Run OpenCode
        uses: anomalyco/opencode/github@latest
        env:
          OPENCODE_ENABLE_EXA: "true"
        with:
          model: openai/gpt-5.3-codex
